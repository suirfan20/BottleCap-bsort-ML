name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:

  # ========================
  # LINT JOB
  # ========================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Black check
        run: black --check src tests

      - name: Isort check
        run: isort src tests --check-only

      - name: Pylint check
        run: pylint src/bsort


  # ========================
  # TEST JOB
  # ========================
  test:
    name: Unit Tests
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest -q


  # ========================
  # DOCKER BUILD & PUSH JOB
  # ========================
  docker:
    name: Docker Compose Build & Test
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & start services
        run: docker compose up -d --build bsort

      - name: Test CLI inside container
        run: docker exec bsort_app bsort --help

      - name: Tear down
        if: always()
        run: docker compose down

   